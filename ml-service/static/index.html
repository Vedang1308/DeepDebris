<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepDebris 2.0 | Mission Control</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Global Error Handler -->
    <script>
        window.addEventListener('error', function (e) {
            const box = document.getElementById('error-box') || document.createElement('div');
            box.id = 'error-box';
            box.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:red;color:white;z-index:9999;padding:10px;font-family:monospace;';
            box.innerText = 'JS Error: ' + e.message + ' at ' + e.filename + ':' + e.lineno;
            document.body.appendChild(box);
            console.error(e);
        });
    </script>

    <!-- Import Map (Using esm.sh for better generated bundles) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"
        crossorigin="anonymous"></script>
</head>

<body>
    <div id="canvas-container"></div>

    <!-- HUD Overlay -->
    <div id="ui-layer">
        <header>
            <h1>üöÄ DeepDebris <span class="badge">LIVE</span></h1>
            <div class="stats">
                <div class="stat-box">
                    <span class="label">ALTITUDE</span>
                    <span class="value" id="alt-val">408 km</span>
                </div>
                <div class="stat-box">
                    <span class="label">VELOCITY</span>
                    <span class="value" id="vel-val">7.66 km/s</span>
                </div>
                <div class="stat-box">
                    <span class="label">F10.7 FLUX</span>
                    <span class="value" id="flux-val">150 sfu</span>
                </div>
            </div>
        </header>

        <aside class="controls">
            <h3>Mission Control</h3>

            <div class="control-group">
                <label>Target Satellite <i class="fas fa-info-circle"
                        title="Select a satellite to track its real-time position."></i></label>
                <div style="display: flex; gap: 5px;">
                    <select id="sat-selector">
                        <option value="25544">ISS (ZARYA)</option>
                        <option value="20580">HUBBLE SPACE TELESCOPE</option>
                        <option value="CUSTOM">Custom TLE</option>
                    </select>
                </div>
            </div>

            <!-- TLE Inputs -->
            <div class="control-group">
                <label>Two-Line Element Set (TLE)</label>
                <input type="text" id="tle1" class="input-text" placeholder="Line 1">
                <input type="text" id="tle2" class="input-text" placeholder="Line 2">
                <button id="btn-fetch-tle" class="action-btn" style="margin-top: 5px;"><i class="fas fa-download"></i>
                    Fetch Latest TLE</button>
            </div>

            <div class="control-group">
                <label>Space Weather Scenario</label>
                <select id="weather-scenario">
                    <option value="LIVE">üõ∞Ô∏è Live NOAA Data</option>
                    <option value="MINIMUM">Solar Minimum (F10.7=65, Kp=0)</option>
                    <option value="QUIET">Quiet (F10.7=70, Kp=1)</option>
                    <option value="NORMAL" selected>Normal (F10.7=150, Kp=3)</option>
                    <option value="MINOR">Minor Storm (F10.7=180, Kp=5)</option>
                    <option value="STORM">Major Storm (F10.7=300, Kp=7)</option>
                    <option value="EXTREME">Extreme Event (F10.7=400, Kp=9)</option>
                </select>
            </div>

            <div class="control-group">
                <div class="slider-row">
                    <label>F10.7 Solar Flux <i class="fas fa-sun"
                            title="Standard measure of Solar Activity. Higher flux = More atmospheric drag on the satellite."></i>
                        : <span id="flux-disp">150</span></label>
                    <input type="range" id="flux-slider" min="50" max="300" value="150"
                        oninput="document.getElementById('flux-disp').innerText = this.value">
                </div>
            </div>
            <div class="control-group">
                <div class="slider-row">
                    <label>Kp Index <i class="fas fa-magnet"
                            title="Geomagnetic Activity Index. Ranges 0-9. Higher Kp = More atmospheric disturbance."></i>
                        : <span id="kp-disp">3.0</span></label>
                    <input type="range" id="kp-slider" min="0" max="9" step="0.1" value="3.0"
                        oninput="document.getElementById('kp-disp').innerText = this.value">
                </div>
            </div>

            <!-- SIMULATION MODE PANEL -->
            <div class="control-group"
                style="border-top: 2px solid rgba(255, 165, 0, 0.3); padding-top: 15px; margin-top: 15px;">
                <label style="color: #ff9500; font-weight: bold;">
                    <i class="fas fa-flask"></i> Simulation Mode
                    <i class="fas fa-info-circle"
                        title="Run 'what-if' collision scenarios without affecting live tracking"></i>
                </label>

                <div class="toggle-group" style="margin-bottom: 10px;">
                    <button id="btn-mode-live" class="active">
                        <i class="fas fa-satellite-dish"></i> Live Tracking
                    </button>
                    <button id="btn-mode-sim">
                        <i class="fas fa-flask"></i> Simulation
                    </button>
                </div>

                <!-- Simulation Controls (hidden by default) -->
                <div id="simulation-controls"
                    style="display: none; margin-top: 10px; padding: 10px; background: rgba(255, 165, 0, 0.1); border-radius: 8px; border: 1px solid rgba(255, 165, 0, 0.3);">
                    <label style="font-size: 12px; color: #ff9500;">Scenario Type:</label>
                    <select id="sim-scenario"
                        style="width: 100%; margin-bottom: 10px; padding: 5px; background: rgba(0,0,0,0.5); color: white; border: 1px solid rgba(255,165,0,0.5); border-radius: 4px;">
                        <option value="collision">Near-Miss Collision</option>
                        <option value="maneuver">Avoidance Maneuver</option>
                        <option value="decay">Orbital Decay</option>
                        <option value="storm">Solar Storm Impact</option>
                    </select>

                    <label style="font-size: 12px; color: #ff9500;">Time Offset (hours):</label>
                    <input type="range" id="sim-time-offset" min="1" max="72" value="24"
                        style="width: 100%; margin-bottom: 5px;"
                        oninput="document.getElementById('sim-time-display').innerText = this.value">
                    <div style="text-align: center; font-size: 11px; color: #aaa; margin-bottom: 10px;">
                        <span id="sim-time-display">24</span> hours
                    </div>

                    <button id="btn-run-simulation" class="action-btn"
                        style="width: 100%; background: linear-gradient(45deg, #ff6b00, #ff9500); margin-bottom: 5px;">
                        <i class="fas fa-play"></i> Run Simulation
                    </button>

                    <button id="btn-reset-simulation" class="action-btn"
                        style="width: 100%; background: linear-gradient(45deg, #666, #888);">
                        <i class="fas fa-undo"></i> Reset to Live
                    </button>

                    <div id="sim-status"
                        style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; font-size: 11px; color: #aaa; text-align: center;">
                        Ready to simulate
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label>Visualization Mode <i class="fas fa-eye"
                        title="Live = Real-time tracking. Predict = Fast-forward simulation to see orbit path."></i></label>
                <div class="toggle-group">
                    <button id="btn-live" class="active"><i class="fas fa-satellite-dish"></i> Live</button>
                    <button id="btn-sim"><i class="fas fa-forward"></i> Predict</button>
                </div>
            </div>

            <!-- DeepDebris 3.0: Autonomous Maneuver Planning -->
            <div class="control-group"
                style="border-top: 2px solid rgba(0, 255, 255, 0.3); padding-top: 15px; margin-top: 15px;">
                <label style="color: #00ffff; font-weight: bold;">
                    <i class="fas fa-rocket"></i> Autonomous Maneuver Planning
                    <i class="fas fa-info-circle"
                        title="AI-powered collision avoidance using Deep Reinforcement Learning"></i>
                </label>

                <!-- Fuel Gauge -->
                <div class="fuel-gauge" style="margin: 10px 0;">
                    <label style="font-size: 12px; color: #aaa;">Fuel Remaining</label>
                    <div class="gauge-bar"
                        style="width: 100%; height: 20px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2);">
                        <div id="fuel-level"
                            style="width: 100%; height: 100%; background: linear-gradient(90deg, #00ff00, #00cc00); transition: width 0.3s, background 0.3s;">
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 11px; color: #aaa; margin-top: 3px;">
                        <span id="fuel-percent">100.0</span>%
                    </div>
                </div>

                <button id="btn-generate-maneuver" class="action-btn"
                    style="width: 100%; background: linear-gradient(45deg, #00aaff, #00ffff); margin-top: 10px;">
                    <i class="fas fa-brain"></i> Generate Maneuver Plan
                </button>

                <!-- Maneuver Info Panel (hidden by default) -->
                <div id="maneuver-panel"
                    style="display: none; margin-top: 10px; padding: 10px; background: rgba(0, 255, 255, 0.1); border-radius: 8px; border: 1px solid rgba(0, 255, 255, 0.3);">
                    <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #00ffff;">üõ∞Ô∏è Optimal Maneuver</h4>
                    <div class="maneuver-details" style="font-size: 11px; color: #ccc;">
                        <p style="margin: 5px 0;"><strong>Thrust Direction:</strong> <span id="thrust-dir"
                                style="color: #00ffff;">-</span></p>
                        <p style="margin: 5px 0;"><strong>Burn Duration:</strong> <span id="burn-time"
                                style="color: #00ffff;">-</span> seconds</p>
                        <p style="margin: 5px 0;"><strong>Execute At:</strong> <span id="exec-time"
                                style="color: #00ffff;">-</span></p>
                        <p style="margin: 5px 0;"><strong>Fuel Cost:</strong> <span id="fuel-cost"
                                style="color: #ff9500;">-</span>%</p>
                        <p style="margin: 5px 0;"><strong>New Miss Distance:</strong> <span id="new-miss"
                                style="color: #00ff00;">-</span> km</p>
                    </div>
                    <button id="execute-maneuver-btn" class="action-btn"
                        style="width: 100%; background: linear-gradient(45deg, #00ff00, #00cc00); margin-top: 10px; font-size: 12px;">
                        <i class="fas fa-play"></i> Execute Maneuver (Simulation)
                    </button>
                </div>
            </div>

            <div id="status-msg">System Online</div>

            <!-- Legend Removed from Sidebar -->
    </div>
    </aside>
    </div>

    <!-- OrbitGPT Chat Widget -->
    <div id="chat-widget">
        <div class="chat-header">
            <span><i class="fas fa-robot"></i> OrbitGPT AI</span>
            <button id="chat-toggle"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="chat-body" id="chat-history">
            <div class="msg ai">Hello! I am monitoring the satellite trajectory. Ask me about collision risks or orbit
                parameters.</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ask OrbitGPT...">
            <button id="chat-send"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- Alerts Dashboard (Screener Output) -->
    <div id="alerts-widget">
        <div class="chat-header">
            <span><i class="fas fa-exclamation-triangle"></i> Collision Alerts</span>
            <button id="alerts-toggle"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="chat-body" id="alerts-list">
            <div class="msg ai">No active alerts. System monitoring...</div>
        </div>
    </div>

    <!-- Floating Legend (Moved to Main View) -->
    <div id="main-legend" style="
        position: fixed; top: 100px; right: 20px;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 8px;
        color: white;
        z-index: 1050;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        backdrop-filter: blur(5px);
        max-width: 250px;
    ">
        <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #aaa; letter-spacing: 1px;">
            Orbit Key</h3>
        <ul style="list-style: none; padding: 0; margin: 0; font-size: 13px;">
            <li style="margin-bottom: 5px; display: flex; align-items: center;"><span
                    style="display:inline-block; width:12px; height:12px; background: magenta; margin-right: 8px; border-radius: 50%;"></span>
                Target (Physics)</li>
            <li style="margin-bottom: 5px; display: flex; align-items: center;"><span
                    style="display:inline-block; width:12px; height:12px; background: cyan; margin-right: 8px; border-radius: 50%;"></span>
                Prediction (AI)</li>
            <li style="margin-bottom: 5px; display: flex; align-items: center;"><span
                    style="display:inline-block; width:12px; height:12px; background: yellow; margin-right: 8px; border-radius: 50%;"></span>
                Debris (Tracked)</li>
            <li style="margin-bottom: 5px; display: flex; align-items: center;"><span
                    style="display:inline-block; width:12px; height:12px; background: lime; margin-right: 8px; border-radius: 50%;"></span>
                Collision Path</li>
        </ul>
    </div>

    <script type="module" src="js/maneuver.js"></script>
    <script type="module" src="js/main.js"></script>
</body>

</html>